<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="./style.css"/>

  <style>
    canvas:focus {
      outline: none;
    }

    html, body {
      padding: 0;
      margin: 0;
      overflow: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      height: 100%;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 4px solid #444;
      border-top-color: #fff;
      animation: spin 0.7s linear infinite;
      margin: 12px auto 0;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <!-- ðŸ”¹ Stub Yandex SDK globals so Unity's plugin doesn't crash -->
  <script>
    (function () {
      function createStubYsdk() {
        const ua = navigator.userAgent || "";
        const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);

        return {
          environment: {
            i18n: {
              lang: "en",     // ðŸ‘ˆ force English
              tld:  "com"
            },
            app: {
              id: "TheLongDrive"
            },
            browser: {
              lang: navigator.language || "en"
            },
            payload: null
          },
          deviceInfo: {
            type: isMobile ? "mobile" : "desktop",
            isMobile: () => isMobile,
            isDesktop: () => !isMobile,
            isTablet: () => false,
            isTV: () => false
          },
          adv: {
            showFullscreenAdv: () => {
              console.log("[ysdk stub] showFullscreenAdv");
              return Promise.resolve();
            },
            showRewardedVideo: () => {
              console.log("[ysdk stub] showRewardedVideo");
              return Promise.resolve();
            }
          },
          feedback: {
            canReview: () => Promise.resolve({ value: false, reason: "stub" }),
            requestReview: () => Promise.resolve({ feedbackSent: false })
          },
          features: {
            GamesAPI: {
              getAllGames: () => Promise.reject("stub: no games api")
            }
          },
          getPayments: () => Promise.reject("stub: no payments"),
          getPlayer: () => Promise.reject("stub: no player"),
          getStorage: () => Promise.resolve({
            setItem: () => Promise.resolve(),
            getItem: () => Promise.resolve(null),
            removeItem: () => Promise.resolve()
          })
        };
      }

      // global ysdk that LangRequest_js is trying to use
      window.ysdk = createStubYsdk();

      // optional: if something still calls YaGames.init, make it just return our stub
      window.YaGames = {
        init: function () {
          console.log("[YaGames stub] init called");
          return Promise.resolve(window.ysdk);
        }
      };
    })();
  </script>
</head>
<body class="dark">
  <div id="unity-container" class="unity-desktop">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
  </div>

  <div id="loading-cover" style="display:none;">
    <div id="unity-loading-bar">
      <div id="unity-logo"><img src="Images/logo.png"/></div>
      <div id="unity-progress-bar-empty" style="display: none;">
        <div id="unity-progress-bar-full"></div>
      </div>
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    const hideFullScreenButton = "";
    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/long_drive.loader.js";
    const config = {
      dataUrl: buildUrl + "/long_drive.data.br",
      frameworkUrl: buildUrl + "/long_drive.framework.js.br",
      codeUrl: buildUrl + "/long_drive.wasm.br",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "PocketSnake",
      productName: "TheLongDrive",
      productVersion: "0.1.0"
    };

    const container = document.querySelector("#unity-container");
    const canvas = document.querySelector("#unity-canvas");
    const loadingCover = document.querySelector("#loading-cover");
    const progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
    const progressBarFull = document.querySelector("#unity-progress-bar-full");
    const spinner = document.querySelector(".spinner");

    let StartUnityInstance;
    let ygGameInstance = null;
    let initGame = false;
    const NO_DATA = "no data";

    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
      container.className = "unity-mobile";
    }

    loadingCover.style.display = "";

    document.addEventListener("contextmenu", (event) => event.preventDefault());
    function FocusGame() {
      window.focus();
      canvas && canvas.focus();
    }
    window.addEventListener("pointerdown", FocusGame);
    window.addEventListener("touchstart", FocusGame);

    document.addEventListener("visibilitychange", function () {
      if (!ygGameInstance) return;

      if (document.hidden) {
        YG2Instance("SetFocusWindowGame", "false");
      } else {
        YG2Instance("SetFocusWindowGame", "true");
      }
    });

    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      StartUnityInstance = function () {
        createUnityInstance(canvas, config, (progress) => {
          if (spinner) spinner.style.display = "none";
          if (progressBarEmpty) progressBarEmpty.style.display = "";
          const adjustedProgress = Math.max(progress, 0.05);
          if (progressBarFull) {
            progressBarFull.style.width = `${100 * adjustedProgress}%`;
          }
        }).then((unityInstance) => {
          ygGameInstance = unityInstance;
          loadingCover.style.display = "none";
        }).catch((message) => {
          console.error(message);
        });
      };

      StartUnityInstance();
    };

    document.body.appendChild(script);

    function YG2Instance(method, arg) {
      if (!ygGameInstance) return;

      const send = () => {
        try {
          if (typeof arg === "undefined") {
            ygGameInstance.SendMessage("YG2Instance", method);
          } else {
            ygGameInstance.SendMessage("YG2Instance", method, arg);
          }
        } catch (e) {
          console.warn("YG2Instance SendMessage failed:", e);
        }
      };

      if (!initGame) {
        setTimeout(send, 100);
      } else {
        send();
      }
    }

    function LogStyledMessage(msg) {
      console.log("%c" + msg, "color: #FFDF73; background-color: #454545");
    }

    function InitGame() {
      initGame = true;
      setTimeout(function () {
        // hook for any "open inter ad" behaviour if you want later
      }, 100);
    }

    // --- STUBS (same as before, unchanged) ---

    LogStyledMessage("PluginYG2 stub (no real Yandex SDK)");

    function RewardedAdvShow(id) {
      try {
        LogStyledMessage("RewardedAdvShow stub: " + id);
        YG2Instance("OpenRewardedAdv");
        setTimeout(() => {
          YG2Instance("RewardAdv", id);
          YG2Instance("CloseRewardedAdv");
          FocusGame();
        }, 500);
      } catch (err) {
        console.error("RewardedAdvShow stub error:", err);
        YG2Instance("ErrorRewardedAdv");
      }
    }

    function InitReview() {
      return Promise.resolve("false");
    }

    function Review() {
      LogStyledMessage("Review stub called");
      YG2Instance("ReviewSent", "false");
      FocusGame();
    }

    let statsSaves = NO_DATA;
    let statsStore = {};

    function SetState(key, value) {
      statsStore[key] = (statsStore[key] || 0) + value;
      LogStyledMessage("SetState stub: " + key + " -> " + statsStore[key]);
    }

    function GetStats() {
      return new Promise((resolve) => {
        try {
          const res = JSON.stringify(statsStore);
          statsSaves = res;
          YG2Instance("ReceiveStats", res);
          resolve(res);
        } catch (e) {
          console.error("GetStats stub error:", e);
          statsSaves = NO_DATA;
          YG2Instance("ReceiveStats", NO_DATA);
          resolve(NO_DATA);
        }
      });
    }

    function SetAllStats(jsonStats) {
      try {
        statsStore = JSON.parse(jsonStats || "{}");
        LogStyledMessage("SetAllStats stub");
      } catch (e) {
        console.error("SetAllStats stub error:", e);
      }
    }

    let paymentsData = NO_DATA;

    function InitPayments() {
      return new Promise((resolve) => {
        paymentsData = NO_DATA;
        YG2Instance("PaymentsEntries", NO_DATA);
        resolve(NO_DATA);
      });
    }

    function BuyPayments(id) {
      LogStyledMessage("BuyPayments stub: " + id);
      YG2Instance("OnPurchaseFailed", id);
      FocusGame();
    }

    function ConsumePurchase(id, onPurchaseSuccess) {
      LogStyledMessage("ConsumePurchase stub: " + id);
      if (onPurchaseSuccess) {
        YG2Instance("OnPurchaseSuccess", id);
      }
    }

    function ConsumePurchases(onPurchaseSuccess) {
      LogStyledMessage("ConsumePurchases stub");
    }

    let allGamesData = NO_DATA;

    function GetAllGames() {
      return new Promise((resolve) => {
        allGamesData = NO_DATA;
        resolve(NO_DATA);
      });
    }

    let nowFullAdOpen = false;

    function InterAdvShow() {
      try {
        if (nowFullAdOpen) return;
        nowFullAdOpen = true;
        LogStyledMessage("InterAdvShow stub");
        YG2Instance("OpenInterAdv");
        setTimeout(() => {
          nowFullAdOpen = false;
          YG2Instance("CloseInterAdv", "true");
          FocusGame();
        }, 500);
      } catch (e) {
        console.error("InterAdvShow stub error:", e);
        YG2Instance("ErrorInterAdv");
        FocusGame();
      }
    }

    let environmentData = NO_DATA;

    function RequestingEnvironmentData() {
      return new Promise((resolve) => {
        try {
          const ua = navigator.userAgent || "";
          let browser = "Other";
          if (/YaBrowser|YaSearchBrowser/i.test(ua)) browser = "Yandex";
          else if (/OPR|Opera/i.test(ua)) browser = "Opera";
          else if (/Firefox/i.test(ua)) browser = "Firefox";
          else if (/Edg/i.test(ua)) browser = "Edge";
          else if (/Chrome/i.test(ua)) browser = "Chrome";
          else if (/Safari/i.test(ua)) browser = "Safari";

          const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);

          const jsonEnvir = {
            language: (navigator.language || "en").split("-")[0],
            domain: window.location.hostname.split(".").pop() || "",
            deviceType: isMobile ? "mobile" : "desktop",
            isMobile: isMobile,
            isDesktop: !isMobile,
            isTablet: false,
            isTV: false,
            appID: document.title || "TheLongDrive",
            browserLang: navigator.language || "en",
            payload: null,
            platform: navigator.platform || "",
            browser: browser
          };

          const res = JSON.stringify(jsonEnvir);
          environmentData = res;
          YG2Instance("SetEnvirData", res);
          LogStyledMessage("Environment Data stub: " + res);
          resolve(res);
        } catch (e) {
          console.error("RequestingEnvironmentData stub error:", e);
          environmentData = NO_DATA;
          YG2Instance("SetEnvirData", NO_DATA);
          resolve(NO_DATA);
        }
      });
    }
  </script>
</body>
</html>
